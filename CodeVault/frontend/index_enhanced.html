<!DOCTYPE html>
<html>
<head>
  <title>StockApp - Professional Technical Analysis Platform</title>
  <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }

    body.light-theme {
      background-color: #f5f5f5;
      color: #1a1a1a;
    }

    body.dark-theme {
      background-color: #1a1a1a;
      color: #e0e0e0;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 280px;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid;
      transition: background-color 0.3s;
    }

    .light-theme .sidebar {
      background-color: #ffffff;
      border-right-color: #e0e0e0;
    }

    .dark-theme .sidebar {
      background-color: #252525;
      border-right-color: #404040;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .theme-toggle {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .light-theme .theme-toggle {
      background-color: #2563eb;
      color: white;
    }

    .dark-theme .theme-toggle {
      background-color: #3b82f6;
      color: white;
    }

    .theme-toggle:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.7;
    }

    .input-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      opacity: 0.8;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .light-theme input,
    .light-theme select {
      background-color: #f9fafb;
      border-color: #d1d5db;
      color: #1a1a1a;
    }

    .dark-theme input,
    .dark-theme select {
      background-color: #374151;
      border-color: #4b5563;
      color: #e0e0e0;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #3b82f6;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background-color: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background-color: #1d4ed8;
    }

    .indicator-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      transition: background-color 0.3s;
    }

    .light-theme .indicator-item {
      background-color: #f9fafb;
    }

    .dark-theme .indicator-item {
      background-color: #374151;
    }

    .indicator-item:hover {
      opacity: 0.9;
    }

    .indicator-name {
      font-size: 13px;
      font-weight: 500;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #2563eb;
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .indicator-params {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }

    .light-theme .indicator-params {
      background-color: #f3f4f6;
    }

    .dark-theme .indicator-params {
      background-color: #2d3748;
    }

    .indicator-params.active {
      display: block;
    }

    .param-input {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid;
      font-size: 12px;
    }

    #plot {
      flex: 1;
      min-height: 600px;
      border-radius: 8px;
      overflow: hidden;
    }

    .watchlist {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .watchlist-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .light-theme .watchlist-item {
      background-color: #f9fafb;
    }

    .dark-theme .watchlist-item {
      background-color: #374151;
    }

    .watchlist-item:hover {
      transform: translateX(4px);
      opacity: 0.9;
    }

    .watchlist-symbol {
      font-weight: 600;
      font-size: 14px;
    }

    .controls-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .controls-row select,
    .controls-row button {
      flex: 1;
    }

    #popupMenu {
      position: absolute;
      display: none;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      border-radius: 6px;
      overflow: hidden;
    }

    .dark-theme #popupMenu {
      background: #374151;
      border-color: #4b5563;
      color: #e0e0e0;
    }

    #popupMenu div {
      padding: 10px 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .light-theme #popupMenu div:hover {
      background-color: #f3f4f6;
    }

    .dark-theme #popupMenu div:hover {
      background-color: #4b5563;
    }

    .keyboard-shortcuts {
      margin-top: 20px;
      padding: 12px;
      border-radius: 6px;
      font-size: 11px;
    }

    .light-theme .keyboard-shortcuts {
      background-color: #fef3c7;
      color: #92400e;
    }

    .dark-theme .keyboard-shortcuts {
      background-color: #422006;
      color: #fde68a;
    }

    .shortcut-item {
      margin-bottom: 4px;
    }

    .kbd {
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-weight: 600;
    }

    .light-theme .kbd {
      background-color: #fcd34d;
    }

    .dark-theme .kbd {
      background-color: #78350f;
    }

    .drawing-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .tool-btn {
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .light-theme .tool-btn {
      background-color: #f3f4f6;
      color: #1f2937;
    }

    .dark-theme .tool-btn {
      background-color: #374151;
      color: #e5e7eb;
    }

    .tool-btn:hover {
      border-color: #3b82f6;
    }

    .tool-btn.active {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
  </style>
</head>
<body class="light-theme">
  <div class="container">
    <div class="sidebar">
      <div class="section">
        <div class="section-title">Symbol & Timeframe</div>
        <div class="input-group">
          <label>Stock Symbol</label>
          <input type="text" id="symbolInput" placeholder="e.g., GE, AAPL, TSLA" />
        </div>
        <div class="input-group">
          <label>Timeframe</label>
          <select id="timeframeSelect">
            <option value="">Select Timeframe</option>
            <option value="1d_1m">1 Day (1min)</option>
            <option value="5d_5m">5 Days (5min)</option>
            <option value="1mo_1h">1 Month (1h)</option>
            <option value="3mo_1d">3 Months (Daily)</option>
            <option value="1y_1d">1 Year (Daily)</option>
            <option value="3y_1wk">3 Years (Weekly)</option>
            <option value="5y_1wk">5 Years (Weekly)</option>
            <option value="10y_1mo">10 Years (Monthly)</option>
            <option value="max_1mo">Max (Monthly)</option>
          </select>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Drawing Tools</div>
        <div class="drawing-toolbar">
          <button class="tool-btn active" data-tool="drawline" title="Trendline (Default)">üìà Line</button>
          <button class="tool-btn" data-tool="drawopenpath" title="Freehand">‚úèÔ∏è Free</button>
          <button class="tool-btn" data-tool="drawrect" title="Rectangle">‚ñ≠ Rect</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Technical Indicators</div>

        <div class="indicator-item">
          <span class="indicator-name">SMA (20)</span>
          <label class="toggle-switch">
            <input type="checkbox" class="indicator-toggle" data-indicator="SMA" data-period="20">
            <span class="slider"></span>
          </label>
        </div>

        <div class="indicator-item">
          <span class="indicator-name">EMA (20)</span>
          <label class="toggle-switch">
            <input type="checkbox" class="indicator-toggle" data-indicator="EMA" data-period="20">
            <span class="slider"></span>
          </label>
        </div>

        <div class="indicator-item">
          <span class="indicator-name">RSI (14)</span>
          <label class="toggle-switch">
            <input type="checkbox" class="indicator-toggle" data-indicator="RSI" data-period="14">
            <span class="slider"></span>
          </label>
        </div>

        <div class="indicator-item">
          <span class="indicator-name">MACD</span>
          <label class="toggle-switch">
            <input type="checkbox" class="indicator-toggle" data-indicator="MACD">
            <span class="slider"></span>
          </label>
        </div>

        <div class="indicator-item">
          <span class="indicator-name">Bollinger Bands</span>
          <label class="toggle-switch">
            <input type="checkbox" class="indicator-toggle" data-indicator="BB" data-period="20">
            <span class="slider"></span>
          </label>
        </div>

        <div class="indicator-item">
          <span class="indicator-name">VWAP</span>
          <label class="toggle-switch">
            <input type="checkbox" class="indicator-toggle" data-indicator="VWAP">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="section watchlist">
        <div class="section-title">Watchlist</div>
        <div class="watchlist-item" data-symbol="GE">
          <div class="watchlist-symbol">GE</div>
        </div>
        <div class="watchlist-item" data-symbol="AAPL">
          <div class="watchlist-symbol">AAPL</div>
        </div>
        <div class="watchlist-item" data-symbol="TSLA">
          <div class="watchlist-symbol">TSLA</div>
        </div>
        <div class="watchlist-item" data-symbol="MSFT">
          <div class="watchlist-symbol">MSFT</div>
        </div>
      </div>

      <div class="keyboard-shortcuts">
        <div class="section-title">Keyboard Shortcuts</div>
        <div class="shortcut-item"><span class="kbd">Delete</span> - Delete selected line</div>
        <div class="shortcut-item"><span class="kbd">Ctrl+Z</span> - Undo (coming soon)</div>
        <div class="shortcut-item"><span class="kbd">Enter</span> - Load chart</div>
      </div>
    </div>

    <div class="main-content">
      <div class="header">
        <h1>üìä StockApp - Professional Technical Analysis</h1>
        <button class="theme-toggle" id="themeToggle">üåô Dark Mode</button>
      </div>

      <div id="plot"></div>
    </div>
  </div>

  <div id="popupMenu"></div>

<script>
  // State management
  let currentSymbol = null;
  let drawnLines = [];
  let selectedLineId = null;
  let relayoutGuard = false;
  let suppressSave = false;
  let currentPeriod = null;
  let currentInterval = '1d';
  let chartData = [];
  let activeIndicators = {};
  let currentTheme = 'light';
  let currentDrawingTool = 'drawline';

  // Theme toggle
  document.getElementById('themeToggle').addEventListener('click', function() {
    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.body.className = currentTheme + '-theme';
    this.textContent = currentTheme === 'light' ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode';

    // Reload chart with new theme
    if (currentSymbol) {
      loadChart();
    }
  });

  // Drawing tool selection
  document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentDrawingTool = this.getAttribute('data-tool');

      const plotDiv = document.getElementById('plot');
      if (plotDiv.layout) {
        Plotly.relayout('plot', { dragmode: currentDrawingTool });
      }
    });
  });

  // Symbol input
  document.getElementById('symbolInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') loadChart();
  });

  // Timeframe selection
  document.getElementById('timeframeSelect').addEventListener('change', function() {
    const val = this.value;
    if (val !== '') {
      const parts = val.split('_');
      currentPeriod = parts[0];
      currentInterval = parts[1];
      loadChart();
    }
  });

  // Watchlist items
  document.querySelectorAll('.watchlist-item').forEach(item => {
    item.addEventListener('click', function() {
      const symbol = this.getAttribute('data-symbol');
      document.getElementById('symbolInput').value = symbol;
      loadChart();
    });
  });

  // Indicator toggles
  document.querySelectorAll('.indicator-toggle').forEach(toggle => {
    toggle.addEventListener('change', function() {
      const indicator = this.getAttribute('data-indicator');
      const period = this.getAttribute('data-period');

      if (this.checked) {
        activeIndicators[indicator] = { period: period || null };
      } else {
        delete activeIndicators[indicator];
      }

      if (currentSymbol) {
        loadChart();
      }
    });
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Delete' && selectedLineId !== null) {
      deleteSelectedLine();
    }
  });

  // Close popup on outside click
  document.addEventListener('click', function(e) {
    const menu = document.getElementById('popupMenu');
    if (menu.style.display !== 'none' && !menu.contains(e.target)) {
      hidePopup();
    }
  });

  function formatVolume(volume) {
    if (volume >= 1000000) {
      const millions = volume / 1000000;
      if (millions >= 100) return Math.round(millions) + 'M';
      if (millions >= 10) return (Math.round(millions * 10) / 10) + 'M';
      return (Math.round(millions * 100) / 100) + 'M';
    } else if (volume >= 1000) {
      const thousands = volume / 1000;
      if (thousands >= 100) return Math.round(thousands) + 'K';
      if (thousands >= 10) return (Math.round(thousands * 10) / 10) + 'K';
      return (Math.round(thousands * 100) / 100) + 'K';
    }
    return Math.round(volume).toString();
  }

  function createAnnotation(line, chartData) {
    const midX = new Date((new Date(line.x0).getTime() + new Date(line.x1).getTime()) / 2);
    const midY = (line.y0 + line.y1) / 2;
    const priceRange = Math.abs(line.y1 - line.y0);
    const baseOffset = Math.max(priceRange * 0.08, 5);

    let yPosition = midY + baseOffset;
    let verticalAlign = 'bottom';

    if (chartData && chartData.length > 0) {
      const midTime = midX.getTime();
      const timeRange = new Date(line.x1).getTime() - new Date(line.x0).getTime();
      const searchRadius = timeRange * 0.1;

      const nearbyCandlesAbove = chartData.filter(candle => {
        const candleTime = new Date(candle.Date).getTime();
        const timeDiff = Math.abs(candleTime - midTime);
        if (timeDiff > searchRadius) return false;
        return candle.High > midY && candle.High < (midY + baseOffset * 2);
      });

      const nearbyCandlesBelow = chartData.filter(candle => {
        const candleTime = new Date(candle.Date).getTime();
        const timeDiff = Math.abs(candleTime - midTime);
        if (timeDiff > searchRadius) return false;
        return candle.Low < midY && candle.Low > (midY - baseOffset * 2);
      });

      if (nearbyCandlesAbove.length > nearbyCandlesBelow.length) {
        yPosition = midY - baseOffset;
        verticalAlign = 'top';
      }
    }

    return {
      x: midX,
      y: yPosition,
      text: formatVolume(line.volume),
      showarrow: false,
      font: { color: currentTheme === 'light' ? "#2563eb" : "#60a5fa", size: 11, family: "Arial, sans-serif" },
      xanchor: 'center',
      yanchor: verticalAlign,
      bgcolor: currentTheme === 'light' ? 'rgba(255, 255, 255, 0.8)' : 'rgba(55, 65, 81, 0.8)',
      borderpad: 3
    };
  }

  function deleteLineFromBackend(lineId) {
    fetch("/delete_line", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ symbol: currentSymbol, line_id: lineId })
    });
  }

  function deleteSelectedLine() {
    if (selectedLineId === null) return;

    drawnLines = drawnLines.filter(line => line.id !== selectedLineId);

    const updatedShapes = drawnLines.map(line => ({
      type: "line",
      x0: line.x0,
      x1: line.x1,
      y0: line.y0,
      y1: line.y1,
      line: { color: currentTheme === 'light' ? "black" : "#9ca3af" },
      _id: line.id
    }));

    const updatedAnnotations = drawnLines.map(line => createAnnotation(line, chartData));

    Plotly.relayout("plot", { shapes: updatedShapes, annotations: updatedAnnotations });
    deleteLineFromBackend(selectedLineId);
    selectedLineId = null;
  }

  function hidePopup() {
    document.getElementById("popupMenu").style.display = "none";
  }

  function updateShapesColors() {
    const plotDiv = document.getElementById('plot');
    const layout = plotDiv.layout;
    const updatedShapes = layout.shapes.map(shape => ({
      ...shape,
      line: {
        ...shape.line,
        color: (shape._id === selectedLineId) ? 'red' : (currentTheme === 'light' ? 'black' : '#9ca3af')
      }
    }));
    Plotly.relayout('plot', { shapes: updatedShapes });
  }

  function getDataCoords(e) {
    const gd = document.getElementById('plot');
    const bb = gd.getBoundingClientRect();
    const px = e.clientX - bb.left;
    const py = e.clientY - bb.top;
    const layout = gd._fullLayout;
    if (!layout) return null;
    const xInPlot = px - layout.margin.l;
    const yInPlot = py - layout.margin.t;
    const xCoord = layout.xaxis.p2c(xInPlot);
    if (!xCoord) return null;
    const xData = new Date(xCoord).getTime();
    const yData = layout.yaxis.p2c(yInPlot);
    return { x: xData, y: yData };
  }

  function distanceToSegment(p, a, b) {
    const dx = b.x - a.x;
    const dy = b.y - a.y;
    if (dx === 0 && dy === 0) return Math.hypot(p.x - a.x, p.y - a.y);
    let t = ((p.x - a.x) * dx + (p.y - a.y) * dy) / (dx * dx + dy * dy);
    t = Math.max(0, Math.min(1, t));
    const projX = a.x + t * dx;
    const projY = a.y + t * dy;
    return Math.hypot(p.x - projX, p.y - projY);
  }

  async function loadChart() {
    const symbol = document.getElementById("symbolInput").value.trim().toUpperCase();
    if (!symbol) return;

    const symbolChanged = (currentSymbol !== symbol);
    currentSymbol = symbol;
    if (symbolChanged) {
      drawnLines = [];
    }
    selectedLineId = null;

    let fetchUrl = `/data/${symbol}?interval=${currentInterval}`;
    if (currentPeriod) {
      fetchUrl += `&period=${currentPeriod}`;
    }

    try {
      const response = await fetch(fetchUrl);
      const data = await response.json();

      if (data.length === 0) {
        alert("No data found for symbol: " + symbol);
        return;
      }

      chartData = data;

      const traces = [{
        x: data.map(row => row.Date),
        open: data.map(row => row.Open),
        high: data.map(row => row.High),
        low: data.map(row => row.Low),
        close: data.map(row => row.Close),
        type: "candlestick",
        name: symbol,
        xaxis: "x",
        yaxis: "y"
      }];

      // Load indicators if any are active
      if (Object.keys(activeIndicators).length > 0) {
        const indicatorConfigs = Object.keys(activeIndicators).map(type => ({
          type: type,
          params: activeIndicators[type].period ? { period: parseInt(activeIndicators[type].period) } : {}
        }));

        const indicatorResponse = await fetch("/indicators", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            symbol: symbol,
            period: currentPeriod,
            interval: currentInterval,
            indicators: indicatorConfigs
          })
        });

        const indicatorData = await indicatorResponse.json();

        // Add SMA/EMA/VWAP/BB to main chart
        if (indicatorData.SMA_20) {
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.SMA_20,
            type: 'scatter',
            mode: 'lines',
            name: 'SMA(20)',
            line: { color: '#f59e0b', width: 2 }
          });
        }

        if (indicatorData.EMA_20) {
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.EMA_20,
            type: 'scatter',
            mode: 'lines',
            name: 'EMA(20)',
            line: { color: '#10b981', width: 2 }
          });
        }

        if (indicatorData.VWAP) {
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.VWAP,
            type: 'scatter',
            mode: 'lines',
            name: 'VWAP',
            line: { color: '#8b5cf6', width: 2 }
          });
        }

        if (indicatorData.BB_upper) {
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.BB_upper,
            type: 'scatter',
            mode: 'lines',
            name: 'BB Upper',
            line: { color: '#6b7280', width: 1, dash: 'dot' }
          });
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.BB_middle,
            type: 'scatter',
            mode: 'lines',
            name: 'BB Middle',
            line: { color: '#6b7280', width: 1 }
          });
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.BB_lower,
            type: 'scatter',
            mode: 'lines',
            name: 'BB Lower',
            line: { color: '#6b7280', width: 1, dash: 'dot' }
          });
        }

        // Add RSI to separate subplot
        if (indicatorData.RSI) {
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.RSI,
            type: 'scatter',
            mode: 'lines',
            name: 'RSI(14)',
            line: { color: '#ef4444', width: 2 },
            xaxis: 'x',
            yaxis: 'y2'
          });
        }

        // Add MACD to separate subplot
        if (indicatorData.MACD) {
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.MACD,
            type: 'scatter',
            mode: 'lines',
            name: 'MACD',
            line: { color: '#3b82f6', width: 2 },
            xaxis: 'x',
            yaxis: 'y3'
          });
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.MACD_signal,
            type: 'scatter',
            mode: 'lines',
            name: 'Signal',
            line: { color: '#f59e0b', width: 2 },
            xaxis: 'x',
            yaxis: 'y3'
          });
          traces.push({
            x: data.map(row => row.Date),
            y: indicatorData.MACD_histogram,
            type: 'bar',
            name: 'Histogram',
            marker: { color: '#10b981' },
            xaxis: 'x',
            yaxis: 'y3'
          });
        }
      }

      const hasRSI = activeIndicators.RSI;
      const hasMACD = activeIndicators.MACD;

      const layout = {
        title: `${symbol} - Technical Analysis`,
        dragmode: currentDrawingTool,
        shapes: [],
        annotations: [],
        xaxis: { rangeslider: { visible: false } },
        yaxis: { title: "Price" },
        paper_bgcolor: currentTheme === 'light' ? '#ffffff' : '#1a1a1a',
        plot_bgcolor: currentTheme === 'light' ? '#ffffff' : '#1a1a1a',
        font: { color: currentTheme === 'light' ? '#1a1a1a' : '#e0e0e0' },
        showlegend: true,
        legend: { x: 0, y: 1.1, orientation: 'h' }
      };

      if (hasRSI) {
        layout.yaxis2 = { title: 'RSI', range: [0, 100] };
      }

      if (hasMACD) {
        layout.yaxis3 = { title: 'MACD' };
      }

      await Plotly.newPlot("plot", traces, layout, { responsive: true });

      const plotDiv = document.getElementById("plot");

      // Load saved lines
      const linesResponse = await fetch(`/lines/${symbol}`);
      const savedLines = await linesResponse.json();

      if (savedLines.length > 0) {
        const shapes = savedLines.map(line => ({
          type: "line",
          x0: line.x0,
          x1: line.x1,
          y0: line.y0,
          y1: line.y1,
          line: { color: currentTheme === 'light' ? "black" : "#9ca3af" },
          _id: line.id
        }));

        const annotations = savedLines.map(line => createAnnotation(line, chartData));

        drawnLines = savedLines;
        suppressSave = true;
        await Plotly.relayout("plot", { shapes, annotations });
        suppressSave = false;
      }

      // Handle line edits
      plotDiv.on('plotly_relayout', function(event) {
        if (relayoutGuard || suppressSave) return;
        relayoutGuard = true;
        setTimeout(() => { relayoutGuard = false; }, 100);

        const shapes = plotDiv.layout.shapes || [];

        shapes.forEach((shape) => {
          if (shape.type !== "line") return;

          if (!shape._id) {
            shape._id = crypto.randomUUID();
          }

          const { x0, x1, y0, y1 } = shape;
          const existing = drawnLines.find(l => l.id === shape._id);

          const coordsChanged = !existing ||
            existing.x0 !== x0 || existing.x1 !== x1 ||
            existing.y0 !== y0 || existing.y1 !== y1;

          if (!coordsChanged) return;

          fetch("/volume", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              symbol: currentSymbol,
              start_date: x0,
              end_date: x1,
              interval: currentInterval
            })
          })
          .then(res => res.json())
          .then(data => {
            const avgVolume = data.avg_volume;
            const lineData = { x0, x1, y0, y1, volume: avgVolume };
            const annotation = createAnnotation(lineData, chartData);

            const layout = plotDiv.layout;
            const annotations = layout.annotations || [];

            if (existing) {
              annotations[drawnLines.indexOf(existing)] = annotation;
              Object.assign(existing, { x0, x1, y0, y1, volume: avgVolume });
            } else {
              annotations.push(annotation);
              drawnLines.push({ id: shape._id, x0, x1, y0, y1, volume: avgVolume });
            }

            Plotly.relayout("plot", { annotations });

            fetch("/save_line", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                symbol: currentSymbol,
                line: { id: shape._id, x0, x1, y0, y1, volume: avgVolume }
              })
            });
          });
        });
      });

      // Handle line selection via click
      plotDiv.addEventListener('click', function(e) {
        const pos = getDataCoords(e);
        if (!pos) return;

        const clicked_time = pos.x;
        const clickedY = pos.y;

        const layout = plotDiv._fullLayout;
        const x_min = new Date(layout.xaxis.range[0]).getTime();
        const x_max = new Date(layout.xaxis.range[1]).getTime();
        const y_min = layout.yaxis.range[0];
        const y_max = layout.yaxis.range[1];

        const clicked_xn = (clicked_time - x_min) / (x_max - x_min);
        const clicked_yn = (clickedY - y_min) / (y_max - y_min);

        let closestId = null;
        let minDistance = Infinity;

        const shapes = plotDiv.layout.shapes || [];

        shapes.forEach((shape) => {
          if (shape.type !== "line") return;

          const x0_time = new Date(shape.x0).getTime();
          const x1_time = new Date(shape.x1).getTime();
          const x0n = (x0_time - x_min) / (x_max - x_min);
          const x1n = (x1_time - x_min) / (x_max - x_min);
          const y0n = (shape.y0 - y_min) / (y_max - y_min);
          const y1n = (shape.y1 - y_min) / (y_max - y_min);

          const dist = distanceToSegment(
            { x: clicked_xn, y: clicked_yn },
            { x: x0n, y: y0n },
            { x: x1n, y: y1n }
          );

          if (dist < minDistance) {
            minDistance = dist;
            closestId = shape._id;
          }
        });

        const threshold = 0.05;
        if (minDistance < threshold) {
          if (closestId === selectedLineId) {
            selectedLineId = null;
          } else {
            selectedLineId = closestId;
          }
        } else {
          selectedLineId = null;
        }

        updateShapesColors();
      });

      // Handle right-click context menu
      plotDiv.addEventListener("contextmenu", function(e) {
        e.preventDefault();

        const menu = document.getElementById("popupMenu");
        menu.innerHTML = '';

        if (selectedLineId !== null) {
          const deleteDiv = document.createElement('div');
          deleteDiv.textContent = 'üóëÔ∏è Delete Selected Line';
          deleteDiv.onclick = function() {
            deleteSelectedLine();
            hidePopup();
          };
          menu.appendChild(deleteDiv);

          menu.style.left = e.pageX + "px";
          menu.style.top = e.pageY + "px";
          menu.style.display = "block";
        }
      });

    } catch (error) {
      console.error("Error loading chart:", error);
      alert("Error loading chart data");
    }
  }
</script>
</body>
</html>
